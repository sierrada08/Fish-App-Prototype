<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gallatin River Fly Recommendation Prototype V2</title>
    <style>
        body {
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            height: 100vh;
            margin: 0;
            font-family: Arial, sans-serif;
            background-color: #f4f4f4;
        }
        h1 {
            text-align: center;
            margin-bottom: 20px;
        }
        .form-group {
            margin-bottom: 10px;
        }
        label {
            display: block;
            margin-bottom: 5px;
        }
        select {
            padding: 5px;
            width: 200px;
        }
        button {
            margin-top: 20px;
            padding: 10px 20px;
            background-color: #007bff;
            color: white;
            border: none;
            cursor: pointer;
            font-size: 16px;
        }
        button:hover {
            background-color: #0056b3;
        }
        #output {
            margin-top: 20px;
            font-weight: bold;
        }
    </style>
</head>
<body>
    <h1>Bozeman Area Fly Recommendation</h1>

    <div class="form-group">
        <label for="river">Select River:</label>
        <select id="river">
            <option value="">--Select a River--</option>
            <option value="gallatin">Gallatin River</option>
            <option value="yellowstone">Yellowstone River</option>
            <option value="madison">Madison River</option>
            <option value="east-gallatin">East Gallatin River</option>
        </select>
    </div>

    <div class="form-group">
        <label for="section">Select Section:</label>
        <select id="section" disabled>
            <option value="">--Select a Section--</option>
        </select>
    </div>

    <div class="form-group">
        <label for="timeOfDay">Time of Day:</label>
        <select id="timeOfDay">
            <option value="early-morning">Early Morning</option>
            <option value="morning">Morning</option>
            <option value="afternoon">Afternoon</option>
            <option value="evening">Evening</option>
        </select>
    </div>

    <div class="form-group">
        <label for="species">Target Fish Species (Trout):</label>
        <select id="species">
            <option value="rainbow-trout">Rainbow Trout</option>
            <option value="cutthroat-trout">Cutthroat Trout</option>
            <option value="brown-trout">Brown Trout</option>
        </select>
    </div>

    <button id="submitBtn" disabled>Submit</button>

    <div id="output"></div>

    <script>
        const riverSections = {
            "gallatin": [
                { section: "Valley", town: "4 Corners, Montana", site: "06043500" },
                { section: "Canyon", town: "Gallatin Canyon", site: "06043500" },
                { section: "Big Sky Area", town: "Big Sky, MT", site: "06043500" }
            ],
            "yellowstone": [
                { section: "Paradise Valley", town: "Emigrant, MT", site: "06191500" },
                { section: "Yankee Jim", town: "Gardiner, MT", site: "06191500" },
                { section: "Lower Yellowstone - Billings", town: "Big Timber, MT", site: "06191500" }
            ],
            "madison": [
                { section: "Upper", town: "Ennis, MT", site: "06038800" },
                { section: "Lower", town: "Norris, MT", site: "06038800" }
            ],
            "east-gallatin": [
                { section: "Bozeman Area", town: "Bozeman, MT", site: "06043900" }
            ]
        };

        document.getElementById('river').addEventListener('change', function() {
            const river = this.value;
            const sectionSelect = document.getElementById('section');
            sectionSelect.innerHTML = '<option value="">--Select a Section--</option>'; // Reset section options

            if (river) {
                sectionSelect.disabled = false;
                riverSections[river].forEach(function(sectionData) {
                    const option = document.createElement('option');
                    option.value = JSON.stringify(sectionData);
                    option.text = sectionData.section;
                    sectionSelect.add(option);
                });
            } else {
                sectionSelect.disabled = true;
            }

            document.getElementById('submitBtn').disabled = true;
        });

        document.getElementById('section').addEventListener('change', function() {
            const sectionData = this.value;
            if (sectionData) {
                document.getElementById('submitBtn').disabled = false;
            } else {
                document.getElementById('submitBtn').disabled = true;
            }
        });

        async function fetchFlowData(site) {
            const url = `https://waterservices.usgs.gov/nwis/iv/?format=json&sites=${site}&parameterCd=00065,00060&period=P7D`;

            const response = await fetch(url);
            const jsonData = await response.json();

            // Extract the most recent flow data
            const flowData = jsonData.value.timeSeries.find(series => series.variable.variableCode[0].value === "00060");
            const mostRecentFlow = flowData.values[0].value.slice(-1)[0].value; // Gets the most recent value

            return mostRecentFlow;
        }

        async function fetchWeatherData(town) {
            const apiKey = 'your-open-meteo-api-key'; // Replace with your actual API key if required
            const encodedTown = encodeURIComponent(town);
            const url = `https://api.open-meteo.com/v1/forecast?latitude=45.3702&longitude=-111.1753&hourly=temperature_2m,precipitation,weathercode,windspeed_10m&timezone=America/Denver`;

            const response = await fetch(url);
            const jsonData = await response.json();

            // Extract the most recent weather data
            const weatherData = jsonData.hourly;
            const currentWeather = {
                temp: weatherData.temperature_2m[0],
                condition: mapWeatherCodeToCondition(weatherData.weathercode[0])
            };

            return currentWeather;
        }

        function mapWeatherCodeToCondition(weatherCode) {
            const conditions = {
                0: "Clear sky",
                1: "Mainly clear",
                2: "Partly cloudy",
                3: "Overcast",
                45: "Fog",
                48: "Depositing rime fog",
                51: "Drizzle: Light",
                53: "Drizzle: Moderate",
                55: "Drizzle: Dense intensity",
                56: "Freezing Drizzle: Light",
                57: "Freezing Drizzle: Dense intensity",
                61: "Rain: Slight",
                63: "Rain: Moderate",
                65: "Rain: Heavy intensity",
                66: "Freezing Rain: Light",
                67: "Freezing Rain: Heavy intensity",
                71: "Snow fall: Slight",
                73: "Snow fall: Moderate",
                75: "Snow fall: Heavy intensity",
                77: "Snow grains",
                80: "Rain showers: Slight",
                81: "Rain showers: Moderate",
                82: "Rain showers: Violent",
                85: "Snow showers: Slight",
                86: "Snow showers: Heavy",
                95: "Thunderstorm: Slight or moderate",
                96: "Thunderstorm with slight hail",
                99: "Thunderstorm with heavy hail"
            };

            return conditions[weatherCode] || "Unknown";
        }

        document.getElementById('submitBtn').addEventListener('click', async function() {
            const timeOfDay = document.getElementById('timeOfDay').value;
            const species = document.getElementById('species').value;
            const sectionData = JSON.parse(document.getElementById('section').value);

            const flow = await fetchFlowData(sectionData.site);
            const weather = await fetchWeatherData(sectionData.town);

            const prompt = `What fly should I use if I am going fishing at ${timeOfDay} on the ${sectionData.section} of the ${sectionData.river}, the flow is ${flow} CFS, and the weather is going to be ${weather.condition} with a temperature of ${weather.temp}Â°C for ${species}?`;

            document.getElementById('output').innerText = prompt;
        });
    </script>
</body>
</html>
